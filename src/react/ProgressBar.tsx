/**
 * React ProgressBar component for inkx/Ink TUI apps
 */

import React, { useState, useEffect, useRef } from "react";
import type { ProgressBarProps } from "../types.js";

/**
 * Progress bar component for React TUI apps
 *
 * @example
 * ```tsx
 * import { ProgressBar } from "@beorn/progressx/react";
 *
 * function DownloadProgress({ current, total }) {
 *   return (
 *     <ProgressBar
 *       value={current}
 *       total={total}
 *       showPercentage
 *       showETA
 *     />
 *   );
 * }
 * ```
 */
export function ProgressBar({
  value,
  total,
  width = 40,
  showPercentage = true,
  showETA = false,
  label,
  color = "cyan",
}: ProgressBarProps): React.ReactElement {
  // ETA calculation state
  const [eta, setEta] = useState<string>("--:--");
  const etaBuffer = useRef<{ time: number; value: number }[]>([]);
  const etaBufferSize = 10;

  // Update ETA buffer when value changes
  useEffect(() => {
    const now = Date.now();
    etaBuffer.current.push({ time: now, value });

    if (etaBuffer.current.length > etaBufferSize) {
      etaBuffer.current.shift();
    }

    // Calculate ETA
    if (etaBuffer.current.length >= 2) {
      const first = etaBuffer.current[0];
      const last = etaBuffer.current[etaBuffer.current.length - 1];

      const elapsed = (last.time - first.time) / 1000;
      const progress = last.value - first.value;

      if (elapsed > 0 && progress > 0) {
        const rate = progress / elapsed;
        const remaining = total - value;
        const etaSeconds = remaining / rate;

        if (isFinite(etaSeconds) && etaSeconds < 86400) {
          const minutes = Math.floor(etaSeconds / 60);
          const seconds = Math.floor(etaSeconds % 60);
          setEta(`${minutes}:${seconds.toString().padStart(2, "0")}`);
        } else {
          setEta("--:--");
        }
      }
    }
  }, [value, total]);

  const percent = total > 0 ? value / total : 0;
  const percentDisplay = `${Math.round(percent * 100)}%`;

  const filledWidth = Math.round(width * percent);
  const emptyWidth = width - filledWidth;

  const bar = "█".repeat(filledWidth) + "░".repeat(emptyWidth);

  // Build the display parts
  const parts: string[] = [];

  if (label) {
    parts.push(label);
  }

  parts.push(`[${bar}]`);

  if (showPercentage) {
    parts.push(percentDisplay.padStart(4));
  }

  if (showETA) {
    parts.push(`ETA: ${eta}`);
  }

  return (
    <span data-progressx-bar data-color={color} data-percent={percent}>
      {parts.join(" ")}
    </span>
  );
}

/**
 * Hook for progress bar state management
 *
 * @example
 * ```tsx
 * function MyProgress() {
 *   const { value, total, update, increment, eta, percent } = useProgressBar(100);
 *
 *   useEffect(() => {
 *     const timer = setInterval(() => increment(), 100);
 *     return () => clearInterval(timer);
 *   }, []);
 *
 *   return <Text>{percent}% - ETA: {eta}</Text>;
 * }
 * ```
 */
export function useProgressBar(initialTotal: number) {
  const [value, setValue] = useState(0);
  const [total, setTotal] = useState(initialTotal);
  const etaBuffer = useRef<{ time: number; value: number }[]>([]);
  const [eta, setEta] = useState<string>("--:--");

  const update = (newValue: number) => {
    setValue(newValue);

    // Update ETA buffer
    const now = Date.now();
    etaBuffer.current.push({ time: now, value: newValue });
    if (etaBuffer.current.length > 10) {
      etaBuffer.current.shift();
    }

    // Calculate ETA
    if (etaBuffer.current.length >= 2) {
      const first = etaBuffer.current[0];
      const last = etaBuffer.current[etaBuffer.current.length - 1];
      const elapsed = (last.time - first.time) / 1000;
      const progress = last.value - first.value;

      if (elapsed > 0 && progress > 0) {
        const rate = progress / elapsed;
        const remaining = total - newValue;
        const etaSeconds = remaining / rate;

        if (isFinite(etaSeconds) && etaSeconds < 86400) {
          const minutes = Math.floor(etaSeconds / 60);
          const seconds = Math.floor(etaSeconds % 60);
          setEta(`${minutes}:${seconds.toString().padStart(2, "0")}`);
        }
      }
    }
  };

  const increment = (amount = 1) => update(value + amount);

  const reset = (newTotal?: number) => {
    setValue(0);
    if (newTotal !== undefined) setTotal(newTotal);
    etaBuffer.current = [];
    setEta("--:--");
  };

  const percent = total > 0 ? Math.round((value / total) * 100) : 0;

  return {
    value,
    total,
    percent,
    eta,
    update,
    increment,
    reset,
    setTotal,
  };
}
